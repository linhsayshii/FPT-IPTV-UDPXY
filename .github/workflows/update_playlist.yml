name: Update FPT Udpxy Playlist

# Chạy tự động vào 4:00 sáng hàng ngày (giờ VN ~ 21:00 UTC) hoặc chạy thủ công
on:
  schedule:
    - cron: '0 21 * * *' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create output directory
      run: mkdir -p IPTV

    - name: Download and Convert M3U
      run: |
        # 1. Định nghĩa các biến
        SOURCE_URL="https://raw.githubusercontent.com/ntd249/ntdiptv/main/fptudp"
        OUTPUT_FILE="IPTV/fpt_udpxy.m3u8"
        
        # Địa chỉ server Udpxy của bạn
        UDPXY_PREFIX="http://172.27.1.37:4022/udp/"

        echo "Đang tải file gốc..."
        curl -s "$SOURCE_URL" -o temp_list.m3u

        echo "Đang chuyển đổi link UDP sang HTTP Udpxy..."
        # Sử dụng sed để thay thế 'udp://@' bằng link udpxy
        # Dùng dấu | làm phân cách để tránh xung đột với dấu / trong url
        sed "s|udp://@|$UDPXY_PREFIX|g" temp_list.m3u > "$OUTPUT_FILE"

        # Xóa file tạm
        rm temp_list.m3u
        
        echo "Hoàn tất chuyển đổi. Kiểm tra 5 dòng đầu:"
        head -n 5 "$OUTPUT_FILE"

    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        git add "$OUTPUT_FILE"
        
        # Kiểm tra xem có thay đổi gì không trước khi commit
        if git diff --staged --quiet; then
          echo "Không có thay đổi nào trong danh sách kênh."
        else
          git commit -m "Auto update playlist: $(date +'%Y-%m-%d')"
          git push
        fi
